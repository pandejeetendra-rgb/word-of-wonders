<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Word of Wonders – Browser Security (GBL)</title>
  <style>
    :root{
      --bg1:#6ec6ff;
      --bg2:#7c4dff;
      --card:#ffffffee;
      --ink:#1f2a37;
      --muted:#6b7280;
      --shadow: 0 10px 25px rgba(0,0,0,.15);
      --shadow2: 0 6px 16px rgba(0,0,0,.12);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      min-height:100vh;
      background:
        radial-gradient(900px 600px at 10% 10%, rgba(255,255,255,.35), transparent 55%),
        radial-gradient(900px 600px at 90% 15%, rgba(255,255,255,.25), transparent 55%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      display:flex;
      justify-content:center;
      padding:18px 12px 28px;
    }
    .wrap{ width:min(520px, 96vw); }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin:6px 4px 12px;
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:2px;
      color:white;
      text-align:left;
    }
    .title h1{ margin:0; font-size:18px; font-weight:800; letter-spacing:.2px; }
    .title small{ opacity:.9; font-size:12px; }

    .pill{
      background: rgba(255,255,255,.18);
      color:#fff;
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      display:flex;
      align-items:center;
      gap:8px;
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,.2);
      white-space:nowrap;
    }
    .pill b{font-weight:800}

    .card{
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
      border: 1px solid rgba(255,255,255,.7);
      backdrop-filter: blur(10px);
    }

    .sectionTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin:2px 2px 10px;
      gap:10px;
    }
    .sectionTitle .left{
      display:flex; flex-direction:column; gap:3px;
      text-align:left;
    }
    .sectionTitle .left b{ font-size:14px; }
    .sectionTitle .left span{ font-size:12px; color:var(--muted); }
    .progress{ font-size:12px; color:var(--muted); white-space:nowrap; }

    /* ✅ Clue board (no answer-revealing chips) */
    .clueBoard{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin: 8px 0 12px;
      padding:12px;
      background: rgba(255,255,255,.55);
      border:1px solid rgba(255,255,255,.65);
      border-radius: 16px;
      box-shadow: var(--shadow2);
    }
    .clueItem{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:10px;
      border-radius: 14px;
      background: rgba(255,255,255,.85);
      border:1px solid rgba(0,0,0,.06);
    }
    .clueNo{
      width:28px;
      height:28px;
      border-radius: 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:12px;
      color:#0f172a;
      background: rgba(59,130,246,.12);
      border: 1px solid rgba(59,130,246,.20);
      flex:0 0 auto;
    }
    .clueText{
      font-size:12px;
      line-height:1.35;
      color:#334155;
    }
    .clueItem.done{
      background: rgba(34,197,94,.10);
      border-color: rgba(34,197,94,.25);
    }
    .clueItem.done .clueNo{
      background: rgba(34,197,94,.16);
      border-color: rgba(34,197,94,.28);
    }

    /* ✅ Crossword grid 10×10 (supports long words) */
    .grid{
      display:grid;
      grid-template-columns: repeat(10, 1fr);
      gap:6px;
      padding:8px;
      background: rgba(255,255,255,.55);
      border-radius: 16px;
      box-shadow: var(--shadow2);
      border:1px solid rgba(255,255,255,.65);
    }
    .cell{
      aspect-ratio: 1 / 1;
      border-radius: 12px;
      background: linear-gradient(180deg, #ffffff, #eef2ff);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:13px;
      color:#0f172a;
      position:relative;
      user-select:none;
      overflow:hidden;
      box-shadow:
        0 8px 14px rgba(15, 23, 42, .08),
        inset 0 1px 0 rgba(255,255,255,.9);
      border: 1px solid rgba(148,163,184,.35);
    }
    .cell.blank{
      background: rgba(255,255,255,.25);
      border:1px dashed rgba(255,255,255,.65);
      color:transparent;
      box-shadow:none;
    }
    .cell.locked{
      background:
        radial-gradient(circle at 30% 25%, rgba(59,130,246,.18), transparent 55%),
        linear-gradient(180deg, #ffffff, #eef2ff);
    }
    .cell.reveal{
      animation: tilePop .18s ease-out;
      background:
        radial-gradient(circle at 30% 25%, rgba(34,197,94,.22), transparent 55%),
        linear-gradient(180deg, #ffffff, #ecfdf5);
      border-color: rgba(34,197,94,.35);
    }
    @keyframes tilePop{ from{transform:scale(.94)} to{transform:scale(1)} }

    .currentWord{
      margin:12px 2px 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .wordBox{
      flex:1;
      background:#ffffffcc;
      border-radius: 14px;
      padding:10px 12px;
      box-shadow: var(--shadow2);
      border: 1px solid rgba(255,255,255,.7);
      min-height:44px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      letter-spacing: 1px;
    }
    .decision{
      font-size:12px;
      color:var(--muted);
      text-align:right;
      min-width:150px;
    }
    .hintLine{
      margin:0 2px 10px;
      text-align:left;
      font-size:12px;
      color:var(--muted);
      background: rgba(255,255,255,.65);
      border:1px solid rgba(255,255,255,.7);
      border-radius: 12px;
      padding:8px 10px;
      box-shadow: var(--shadow2);
    }
    .hintLine b{ color:#334155; }

    .wheelWrap{
      margin-top:10px;
      background: rgba(255,255,255,.55);
      border: 1px solid rgba(255,255,255,.65);
      box-shadow: var(--shadow2);
      border-radius: 20px;
      padding:14px 10px 10px;
      position:relative;
      overflow:hidden;
    }
    .wheelHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 6px 10px;
      color:var(--muted);
      font-size:12px;
      gap:10px;
    }
    .wheel{
      width: 280px;
      height: 280px;
      margin: 0 auto;
      position: relative;
      border-radius: 50%;
      background: radial-gradient(circle at 40% 35%, rgba(255,255,255,.95), rgba(255,255,255,.55));
      border: 1px solid rgba(255,255,255,.8);
      box-shadow: inset 0 0 0 10px rgba(59,130,246,.08), var(--shadow2);
      touch-action: none;
      user-select:none;
    }
    .letter{
      width: 54px;
      height: 54px;
      border-radius: 50%;
      position:absolute;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:18px;
      background: linear-gradient(180deg, #3b82f6, #2563eb);
      color:white;
      box-shadow: 0 10px 18px rgba(37,99,235,.25);
      border: 1px solid rgba(255,255,255,.35);
    }
    .letter.selected{ background: linear-gradient(180deg, #22c55e, #16a34a); }
    .wheel svg{ position:absolute; inset:0; pointer-events:none; }
    .wheel path{
      stroke: rgba(34,197,94,.9);
      stroke-width: 10;
      stroke-linecap: round;
      fill:none;
      filter: drop-shadow(0 6px 10px rgba(22,163,74,.25));
    }

    .actions{
      display:flex;
      gap:10px;
      justify-content:center;
      margin-top:12px;
      flex-wrap:wrap;
    }
    .btn{
      border:none;
      border-radius: 12px;
      padding:10px 14px;
      font-weight:800;
      cursor:pointer;
      box-shadow: var(--shadow2);
      background:#fff;
      color:var(--ink);
    }
    .btn.primary{
      background: linear-gradient(180deg, #111827, #0b1220);
      color:#fff;
    }
    .btn.ghost{ background: rgba(255,255,255,.75); }

    .tokens{
      margin-top:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.75);
      border: 1px solid rgba(255,255,255,.7);
      box-shadow: var(--shadow2);
    }
    .tokenRow{ display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end; }
    .token{
      width:18px; height:18px; border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #86efac, #22c55e);
      box-shadow: 0 6px 12px rgba(34,197,94,.25);
      border:1px solid rgba(255,255,255,.55);
    }
    .msg{ margin-top:8px; font-size:12px; color:var(--muted); }

    /* MCQ modal */
    .modal{
      display:none;
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      padding:18px 12px;
      z-index:50;
    }
    .modalBox{
      width:min(520px, 96vw);
      margin: 9vh auto 0;
      background:#fff;
      border-radius: 18px;
      padding:14px;
      box-shadow: var(--shadow);
      text-align:left;
    }
    .modalTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .badge{
      background: rgba(59,130,246,.12);
      color:#1d4ed8;
      border:1px solid rgba(59,130,246,.25);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
    }
    .q{ margin:10px 0 8px; font-weight:800; line-height:1.35; }
    .opt{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:10px;
      border-radius: 12px;
      border:1px solid #e5e7eb;
      margin:8px 0;
      cursor:pointer;
    }
    .opt:hover{background:#f9fafb}
    .opt input{margin-top:3px}
    .modalActions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      margin-top:10px;
      flex-wrap:wrap;
    }

    @media (max-width:380px){
      .wheel{ width: 250px; height: 250px; }
      .letter{ width:50px; height:50px; font-size:17px; }
      .grid{ gap:5px; }
      .cell{ font-size:12px; }
      .decision{ min-width:120px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Word of Wonders – Browser Security</h1>
        <small>Find word → mandatory MCQ → correct required to progress</small>
      </div>
      <div class="pill">
        <span>Tokens</span> <b id="tokenCount">0</b>
      </div>
    </header>

    <div class="card">
      <div class="sectionTitle">
        <div class="left">
          <b>Crossword Board</b>
          <span>Complete all words to finish the level</span>
        </div>
        <div class="progress" id="progressText">0 / 0</div>
      </div>

      <!-- ✅ Clue-only board (no direct answer hints) -->
      <div class="clueBoard" id="clueBoard"></div>

      <div class="grid" id="grid"></div>

      <div class="currentWord">
        <div class="wordBox" id="currentWord"> </div>
        <div class="decision" id="decisionHint">Theme: —</div>
      </div>

      <div class="hintLine" id="hintText"><b>Hint (current):</b> —</div>

      <div class="wheelWrap">
        <div class="wheelHeader">
          <span>Swipe/select letters to form the word</span>
          <span id="patternText">Pattern: —</span>
        </div>

        <div class="wheel" id="wheel">
          <svg viewBox="0 0 280 280" preserveAspectRatio="none">
            <path id="swipePath" d=""></path>
          </svg>
        </div>

        <div class="actions">
          <button class="btn primary" id="submitBtn">Submit Word</button>
          <button class="btn ghost" id="resetBtn">Reset</button>
          <button class="btn ghost" id="shuffleBtn">Shuffle</button>
        </div>

        <div class="tokens">
          <div>
            <b>Decision Tokens</b>
            <div class="msg">Earn 1 token per validated word</div>
          </div>
          <div class="tokenRow" id="tokenRow"></div>
        </div>
      </div>
    </div>

    <!-- MCQ modal -->
    <div class="modal" id="mcqModal">
      <div class="modalBox">
        <div class="modalTop">
          <div class="badge" id="mcqBadge">MCQ</div>
          <div class="badge">Correct required</div>
        </div>
        <div class="q" id="mcqQuestion"></div>
        <div id="mcqOptions"></div>
        <div class="modalActions">
          <button class="btn ghost" id="mcqReset">Clear</button>
          <button class="btn primary" id="mcqSubmit">Submit Answer</button>
        </div>
        <div class="msg" id="mcqMsg"></div>
      </div>
    </div>

  </div>

<script>
  /* SETTINGS */
  const ROWS = 10;
  const COLS = 10;
  const EXTRA_LETTERS = 2;         // keep low cognitive load
  const SHUFFLE_MCQ_OPTIONS = true;

  /* ROUNDS (browser security words) */
  const rounds = [
    { word:"SECURITY", theme:"Browser Protection", hint:"A browser must protect users from online threats.",
      mcq:{ q:"Which is the best meaning of browser security?",
        options:["Making the browser look attractive","Protecting users from threats and unsafe websites","Increasing screen brightness","Reducing monitor size"],
        answerIndex:1 } },
    { word:"PRIVACY", theme:"Data Protection", hint:"Browsers differ in how they handle user data.",
      mcq:{ q:"What does browser privacy mainly focus on?",
        options:["Preventing collection and misuse of user data","Improving speaker volume","Increasing download speed only","Changing wallpaper automatically"],
        answerIndex:0 } },
    { word:"UPDATES", theme:"Vulnerability Fixes", hint:"Regular fixes help close known vulnerabilities.",
      mcq:{ q:"Why are regular browser updates important?",
        options:["They add random pop-ups","They remove the keyboard","They fix security issues and bugs","They disable encryption"],
        answerIndex:2 } },
    { word:"MALWARE", theme:"Threat Awareness", hint:"Some software is designed to harm systems or steal data.",
      mcq:{ q:"Malware is best described as:",
        options:["A helpful system tool","A security patch","A type of internet cable","Software intended to harm or steal information"],
        answerIndex:3 } },
    { word:"HTTPS", theme:"Secure Connection", hint:"Secure communication protects data during transmission.",
      mcq:{ q:"HTTPS is important because it:",
        options:["Helps secure data exchanged between browser and website","Makes the website offline","Blocks all cookies automatically","Turns off the network card"],
        answerIndex:0 } },
    { word:"ENCRYPT", theme:"Confidentiality", hint:"Sensitive data should not be readable in plain form.",
      mcq:{ q:"Encryption means:",
        options:["Deleting data permanently","Converting data into unreadable form without a key","Increasing screen resolution","Adding more bookmarks"],
        answerIndex:1 } },
    { word:"SANDBOX", theme:"Isolation", hint:"Isolation helps prevent malicious code from spreading.",
      mcq:{ q:"Sandboxing in a browser helps by:",
        options:["Running content in isolation to limit damage","Saving passwords in plain text","Allowing all extensions without checks","Disabling updates permanently"],
        answerIndex:0 } },
    { word:"CERT", theme:"Trust & Certificates", hint:"Websites use digital proof to establish trust.",
      mcq:{ q:"A digital certificate is mainly used to:",
        options:["Increase the size of images","Prove a website’s identity and enable secure connection","Add more advertisements","Disable HTTPS"],
        answerIndex:1 } },
    { word:"PASSWORD", theme:"Account Safety", hint:"Weak credentials make accounts vulnerable.",
      mcq:{ q:"Which password practice is the safest?",
        options:["Using the same password everywhere","Using short passwords like 12345","Using strong, unique passwords for important accounts","Sharing passwords with friends"],
        answerIndex:2 } },
    { word:"COOKIES", theme:"Tracking Controls", hint:"Small files can track user activity across websites.",
      mcq:{ q:"Cookies are primarily used to:",
        options:["Store small pieces of data like session and preferences","Repair a hard disk","Encrypt all web traffic automatically","Turn off the browser"],
        answerIndex:0 } },
    { word:"TRACKING", theme:"Online Behaviour", hint:"Some websites follow user behaviour online.",
      mcq:{ q:"Online tracking generally refers to:",
        options:["Monitoring user activity for ads/analytics across sites","Cleaning the computer screen","Increasing browser window size","Storing files only on USB drive"],
        answerIndex:0 } },
    { word:"EXTENSION", theme:"Add-ons Risk", hint:"Add-ons can improve features but may introduce risks.",
      mcq:{ q:"Which is a security risk with browser extensions?",
        options:["They always improve privacy","They can request excessive permissions and misuse data","They automatically remove malware","They replace HTTPS with HTTP"],
        answerIndex:1 } },
  ];

  /* STATE */
  let currentRoundIndex = 0;
  let validated = new Set();

  let wheelLetters = [];
  let selectedIndices = [];
  let currentWord = "";

  let placement = null;
  let gridState = makeEmptyGrid();

  /* DOM */
  const $ = (id) => document.getElementById(id);

  function shuffle(arr){
    const a = arr.slice();
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]] = [a[j],a[i]];
    }
    return a;
  }
  function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

  /* ✅ clue-only board */
  function renderClueBoard(){
    const el = $("clueBoard");
    el.innerHTML = "";

    rounds.forEach((r, idx)=>{
      const item = document.createElement("div");
      item.className = "clueItem" + (validated.has(r.word) ? " done" : "");
      item.innerHTML = `
        <div class="clueNo">${idx+1}</div>
        <div class="clueText"><b>Clue:</b> ${r.hint}</div>
      `;
      el.appendChild(item);
    });
  }

  /* GRID */
  function makeEmptyGrid(){
    const grid = [];
    for(let r=0;r<ROWS;r++){
      const row = [];
      for(let c=0;c<COLS;c++){
        row.push({ letter:"", active:false, revealed:false });
      }
      grid.push(row);
    }
    return grid;
  }

  function choosePlacement(word){
    const dir = Math.random() < 0.5 ? "H" : "V";
    if(dir === "H"){
      const r0 = randInt(0, ROWS-1);
      const c0 = randInt(0, COLS-word.length);
      const cells = [];
      for(let i=0;i<word.length;i++) cells.push({r:r0, c:c0+i});
      return {r0,c0,dir,cells};
    }else{
      const r0 = randInt(0, ROWS-word.length);
      const c0 = randInt(0, COLS-1);
      const cells = [];
      for(let i=0;i<word.length;i++) cells.push({r:r0+i, c:c0});
      return {r0,c0,dir,cells};
    }
  }

  function applyPlacement(word, pl){
    gridState = makeEmptyGrid();
    pl.cells.forEach((pos, i)=>{
      gridState[pos.r][pos.c].letter = word[i];
      gridState[pos.r][pos.c].active = true;
      gridState[pos.r][pos.c].revealed = validated.has(word);
    });
    renderGrid();
  }

  function renderGrid(){
    const gridEl = $("grid");
    gridEl.innerHTML = "";
    for(let r=0;r<ROWS;r++){
      for(let c=0;c<COLS;c++){
        const cell = gridState[r][c];
        const d = document.createElement("div");
        d.className = "cell";
        if(!cell.active) d.classList.add("blank");
        if(cell.active) d.classList.add("locked");
        if(cell.revealed) d.classList.add("reveal");
        d.textContent = cell.revealed ? cell.letter : (cell.active ? "" : "");
        gridEl.appendChild(d);
      }
    }
  }

  function revealWordOnGrid(){
    placement.cells.forEach((pos)=>{ gridState[pos.r][pos.c].revealed = true; });
    renderGrid();
  }

  /* ✅ SAFE WHEEL LETTER GENERATION
     Rule: no consecutive letters of the target word are adjacent on the wheel (circular adjacency)
  */
  function buildWheelLetters(word){
    const base = word.split("");
    const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");

    const extras = [];
    for(let i=0;i<EXTRA_LETTERS;i++){
      extras.push(alphabet[randInt(0, alphabet.length-1)]);
    }

    const letters = base.concat(extras);

    // forbidden adjacency pairs: (word[i], word[i+1]) and reverse
    const forbidden = new Set();
    for(let i=0;i<word.length-1;i++){
      const a = word[i], b = word[i+1];
      forbidden.add(a + "|" + b);
      forbidden.add(b + "|" + a);
    }

    // try many shuffles to satisfy constraint
    for(let attempt=0; attempt<2500; attempt++){
      const candidate = shuffle(letters);
      let ok = true;

      for(let i=0;i<candidate.length;i++){
        const a = candidate[i];
        const b = candidate[(i+1) % candidate.length]; // circular neighbor
        if(forbidden.has(a + "|" + b)){
          ok = false;
          break;
        }
      }
      if(ok) return candidate;
    }

    // fallback (rare)
    return shuffle(letters);
  }

  function renderWheel(){
    const wheel = $("wheel");
    wheel.innerHTML = `
      <svg viewBox="0 0 280 280" preserveAspectRatio="none">
        <path id="swipePath" d=""></path>
      </svg>
    `;

    const centerX = 140, centerY = 140;
    const radius = 95;
    const n = wheelLetters.length;

    const positions = [];
    for(let i=0;i<n;i++){
      const angle = (Math.PI*2*i/n) - Math.PI/2;
      const x = centerX + radius*Math.cos(angle);
      const y = centerY + radius*Math.sin(angle);
      positions.push({x,y});
    }

    wheelLetters.forEach((ch, i)=>{
      const div = document.createElement("div");
      div.className = "letter";
      div.dataset.index = String(i);
      div.textContent = ch;

      const {x,y} = positions[i];
      div.style.left = (x - 27) + "px";
      div.style.top  = (y - 27) + "px";

      div.addEventListener("pointerdown", (e)=>startSelect(e, i));
      div.addEventListener("pointerenter", (e)=>continueSelect(e, i));

      wheel.appendChild(div);
    });

    wheel.addEventListener("pointermove", onPointerMove);
    window.addEventListener("pointerup", endSelect);

    updateSwipePath();
  }

  let isSelecting = false;
  let lastPointer = {x:0,y:0};

  function startSelect(e, idx){
    e.preventDefault();
    isSelecting = true;
    selectedIndices = [];
    currentWord = "";
    markSelected(idx);
    lastPointer = getLocalPoint(e);
    updateCurrentWord();
  }

  function continueSelect(e, idx){
    if(!isSelecting) return;
    if(e.buttons === 0) return;
    markSelected(idx);
    lastPointer = getLocalPoint(e);
    updateCurrentWord();
  }

  function onPointerMove(e){
    if(!isSelecting) return;
    lastPointer = getLocalPoint(e);
    updateSwipePath(true);
  }

  function endSelect(){
    if(!isSelecting) return;
    isSelecting = false;
    updateSwipePath(false);
  }

  function markSelected(idx){
    if(selectedIndices.includes(idx)) return;
    selectedIndices.push(idx);
    currentWord += wheelLetters[idx];

    document.querySelectorAll(".letter").forEach(el=>{
      const i = parseInt(el.dataset.index,10);
      el.classList.toggle("selected", selectedIndices.includes(i));
    });
    updateSwipePath(true);
  }

  function resetSelection(){
    selectedIndices = [];
    currentWord = "";
    document.querySelectorAll(".letter").forEach(el=>el.classList.remove("selected"));
    const p = document.getElementById("swipePath");
    if(p) p.setAttribute("d","");
    updateCurrentWord();
  }

  function getLocalPoint(e){
    const rect = $("wheel").getBoundingClientRect();
    const x = (e.clientX - rect.left) * (280 / rect.width);
    const y = (e.clientY - rect.top)  * (280 / rect.height);
    return {x,y};
  }

  function getLetterCenter(idx){
    const el = document.querySelector(`.letter[data-index="${idx}"]`);
    if(!el) return {x:140,y:140};
    const wheelRect = $("wheel").getBoundingClientRect();
    const r = el.getBoundingClientRect();
    const cx = ( (r.left + r.width/2) - wheelRect.left ) * (280 / wheelRect.width);
    const cy = ( (r.top  + r.height/2) - wheelRect.top )  * (280 / wheelRect.height);
    return {x:cx, y:cy};
  }

  function updateSwipePath(withPointer=false){
    const p = document.getElementById("swipePath");
    if(!p) return;

    const pts = selectedIndices.map(getLetterCenter);
    if(withPointer && isSelecting && pts.length>0){
      pts.push(lastPointer);
    }
    if(pts.length<2){
      p.setAttribute("d","");
      return;
    }
    let d = `M ${pts[0].x.toFixed(2)} ${pts[0].y.toFixed(2)}`;
    for(let i=1;i<pts.length;i++){
      d += ` L ${pts[i].x.toFixed(2)} ${pts[i].y.toFixed(2)}`;
    }
    p.setAttribute("d", d);
  }

  function updateCurrentWord(){
    $("currentWord").textContent = currentWord || " ";
  }

  /* MCQ */
  function openMCQ(round){
    $("mcqModal").style.display = "block";
    $("mcqBadge").textContent = `MCQ check (word found)`;
    $("mcqQuestion").textContent = round.mcq.q;
    $("mcqMsg").textContent = "Correct answer is required to validate. Retry allowed.";

    const opts = $("mcqOptions");
    opts.innerHTML = "";

    const optionItems = round.mcq.options.map((t,i)=>({t,i}));
    const rendered = SHUFFLE_MCQ_OPTIONS ? shuffle(optionItems) : optionItems;

    opts.dataset.correct = String(rendered.findIndex(x => x.i === round.mcq.answerIndex));

    rendered.forEach((o, idx)=>{
      const div = document.createElement("label");
      div.className = "opt";
      div.innerHTML = `
        <input type="radio" name="mcq" value="${idx}">
        <div><b>${String.fromCharCode(65+idx)}.</b> ${o.t}</div>
      `;
      opts.appendChild(div);
    });
  }
  function closeMCQ(){ $("mcqModal").style.display = "none"; }

  /* small celebration (optional but nice) */
  function burst(){
    const b = document.createElement("div");
    b.style.position="fixed";
    b.style.left="50%";
    b.style.top="45%";
    b.style.width="12px";
    b.style.height="12px";
    b.style.borderRadius="50%";
    b.style.transform="translate(-50%,-50%)";
    b.style.pointerEvents="none";
    b.style.boxShadow = `
      0 -30px 0 rgba(34,197,94,.9),
      0  30px 0 rgba(34,197,94,.7),
      30px 0 0 rgba(59,130,246,.85),
      -30px 0 0 rgba(59,130,246,.75),
      22px -22px 0 rgba(168,85,247,.8),
      -22px 22px 0 rgba(168,85,247,.7),
      -22px -22px 0 rgba(251,191,36,.85),
      22px 22px 0 rgba(251,191,36,.75)
    `;
    document.body.appendChild(b);
    b.animate(
      [{transform:"translate(-50%,-50%) scale(.8)", opacity:1},
       {transform:"translate(-50%,-60%) scale(1.4)", opacity:0}],
      {duration:520, easing:"cubic-bezier(.2,.9,.2,1)"}
    );
    setTimeout(()=>b.remove(), 600);
  }

  /* ROUND FLOW */
  function setRound(i){
    currentRoundIndex = i;
    const round = rounds[currentRoundIndex];

    $("decisionHint").textContent = `Theme: ${round.theme}`;
    $("hintText").innerHTML = `<b>Hint (current):</b> ${round.hint}`;
    $("progressText").textContent = `${validated.size} / ${rounds.length}`;

    placement = choosePlacement(round.word);
    applyPlacement(round.word, placement);

    const rowLabel = placement.r0 + 1;
    const colLabel = String.fromCharCode(65 + placement.c0);
    $("patternText").textContent = `Pattern: ${placement.dir}-${rowLabel}${colLabel}`;

    wheelLetters = buildWheelLetters(round.word);
    renderWheel();

    renderClueBoard();
    resetSelection();
  }

  function addToken(){
    const t = document.createElement("div");
    t.className = "token";
    $("tokenRow").appendChild(t);
    $("tokenCount").textContent = String(validated.size);
  }

  function checkCompletion(){
    $("progressText").textContent = `${validated.size} / ${rounds.length}`;
    renderClueBoard();
    if(validated.size === rounds.length){
      setTimeout(()=> alert("Level Complete! All clues validated."), 80);
    }
  }

  /* ACTIONS */
  $("submitBtn").addEventListener("click", ()=>{
    const round = rounds[currentRoundIndex];

    if(currentWord !== round.word){
      alert("Not matched. Use the sentence clue and try again.");
      return;
    }
    if(validated.has(round.word)){
      alert("Already validated.");
      return;
    }
    openMCQ(round);
  });

  $("resetBtn").addEventListener("click", resetSelection);

  $("shuffleBtn").addEventListener("click", ()=>{
    // keep shuffle but still protect adjacency: rebuild safe wheel again
    const round = rounds[currentRoundIndex];
    wheelLetters = buildWheelLetters(round.word);
    renderWheel();
    resetSelection();
  });

  $("mcqReset").addEventListener("click", ()=>{
    document.querySelectorAll('input[name="mcq"]').forEach(r=>r.checked=false);
    $("mcqMsg").textContent = "Selection cleared.";
  });

  $("mcqSubmit").addEventListener("click", ()=>{
    const sel = document.querySelector('input[name="mcq"]:checked');
    if(!sel){
      $("mcqMsg").textContent = "Please select an option.";
      return;
    }
    const correct = parseInt($("mcqOptions").dataset.correct,10);
    const picked = parseInt(sel.value,10);

    if(picked !== correct){
      $("mcqMsg").textContent = "Incorrect. Try again (no penalty).";
      return;
    }

    const round = rounds[currentRoundIndex];
    validated.add(round.word);

    revealWordOnGrid();
    addToken();
    burst();
    closeMCQ();
    resetSelection();

    const next = currentRoundIndex + 1;
    if(next < rounds.length){
      setRound(next);
    }
    checkCompletion();
  });

  /* INIT */
  (function init(){
    $("progressText").textContent = `0 / ${rounds.length}`;
    renderClueBoard();
    setRound(0);
  })();
</script>
</body>
</html>
